<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>British/American English Spelling Checker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Spell Cheque</h1>
            <p class="description">Analyze text to determine British vs. American English spelling variations.</p>
        </header>

        <main>
            <section class="input-section">
                <form method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="text_input">Paste Text Here:</label>
                        <textarea id="text_input" name="text_input" rows="6" placeholder="Enter or paste your text here for analysis..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="file_upload">Upload File:</label>
                        <input type="file" id="file_upload" name="file_upload" accept=".txt,.pdf">
                        <small class="form-text">Supported formats: .txt, .pdf</small>
                    </div>

                    <div class="form-group">
                        <label for="url_input">Enter URL:</label>
                        <input type="text" id="url_input" name="url_input" placeholder="https://example.com">
                    </div>

                    <div class="form-group">
                        <button type="submit" class="analyze-btn">Analyze Text</button>
                    </div>
                </form>
            </section>

            {% if error_message %}
            <section class="error-section">
                <div class="error-message">
                    <p>{{ error_message }}</p>
                </div>
            </section>
            {% endif %}

            {% if analysis_results %}
            <section class="results-section">
                <h2>Spelling Analysis Results</h2>
                
                {% if analysis_results.total_found > 0 %}
                <div class="chart-container">
                    <canvas id="spellingChart"></canvas>
                </div>

                <div class="summary-stats">
                    <p><strong>Total words analyzed with spelling variations:</strong> {{ analysis_results.total_found }}</p>
                    <p><strong>British English spellings:</strong> {{ analysis_results.british_count }} ({{ analysis_results.british_percentage|round(1) }}%)</p>
                    <p><strong>American English spellings:</strong> {{ analysis_results.american_count }} ({{ analysis_results.american_percentage|round(1) }}%)</p>
                </div>

                <h3>Detailed Word Analysis</h3>
                <div class="table-container">
                    <table class="word-table">
                        <thead>
                            <tr>
                                <th>British Spelling</th>
                                <th>American Spelling</th>
                                <th>British Count</th>
                                <th>American Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for word in analysis_results.found_words_summary %}
                            <tr>
                                <td class="british-word">{{ word.bre_spelling }}</td>
                                <td class="american-word">{{ word.ame_spelling }}</td>
                                <td>{{ word.bre_count }}</td>
                                <td>{{ word.ame_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-results">
                    <p>No relevant British/American spelling variations found in the provided text based on the current dictionary.</p>
                </div>
                {% endif %}
            </section>
            {% endif %}
        </main>

        <footer>
            <p>&copy; 2025 British/American English Spelling Checker</p>
        </footer>
        
        <!-- Store original text in a hidden element -->
        <div id="original-text-container" style="display: none;">
            {{ original_text | safe }}
        </div>
        
        <!-- Modal for displaying highlighted text -->
        <div id="highlight-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="highlight-modal-title">Highlighted Text</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="highlighted-text"></div>
                </div>
            </div>
        </div>
    </div>

    {% if analysis_results and analysis_results.total_found > 0 %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('spellingChart').getContext('2d');
            const spellingChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['British English', 'American English'],
                    datasets: [{
                        data: [{{ analysis_results.british_count }}, {{ analysis_results.american_count }}],
                        backgroundColor: [
                            '#4f9df5', // British - brighter blue for dark mode
                            '#ff5252'  // American - brighter red for dark mode
                        ],
                        borderColor: '#1e1e1e',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#f5f5f5' // Light text color for dark mode
                            }
                        },
                        tooltip: {
                            backgroundColor: '#333333',
                            titleColor: '#ffc145', // Primary color for titles
                            bodyColor: '#f5f5f5',
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Make words in the table clickable
            const britishWords = document.querySelectorAll('.british-word');
            const americanWords = document.querySelectorAll('.american-word');
            
            britishWords.forEach(word => {
                word.classList.add('clickable-word');
                word.addEventListener('click', function() {
                    highlightWord(this.textContent, 'british');
                });
            });
            
            americanWords.forEach(word => {
                word.classList.add('clickable-word');
                word.addEventListener('click', function() {
                    highlightWord(this.textContent, 'american');
                });
            });
            
            // Close modal when clicking the X
            document.querySelector('.close-modal').addEventListener('click', function() {
                document.getElementById('highlight-modal').style.display = 'none';
                
                // Remove selected-word class from all words
                document.querySelectorAll('.selected-word').forEach(el => {
                    el.classList.remove('selected-word');
                });
            });
            
            // Close modal when clicking outside the content
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('highlight-modal')) {
                    document.getElementById('highlight-modal').style.display = 'none';
                    
                    // Remove selected-word class from all words
                    document.querySelectorAll('.selected-word').forEach(el => {
                        el.classList.remove('selected-word');
                    });
                }
            });
        });
        
        function highlightWord(word, variant) {
            // Get the original text
            const originalText = document.getElementById('original-text-container').textContent;
            
            // Get both British and American forms of the word
            let britishWord, americanWord;
            if (variant === 'british') {
                britishWord = word;
                // Find the corresponding American spelling
                const row = Array.from(document.querySelectorAll('.british-word')).find(el => 
                    el.textContent.toLowerCase() === word.toLowerCase());
                if (row) {
                    const tableRow = row.closest('tr');
                    americanWord = tableRow.querySelector('.american-word').textContent;
                }
            } else {
                americanWord = word;
                // Find the corresponding British spelling
                const row = Array.from(document.querySelectorAll('.american-word')).find(el => 
                    el.textContent.toLowerCase() === word.toLowerCase());
                if (row) {
                    const tableRow = row.closest('tr');
                    britishWord = tableRow.querySelector('.british-word').textContent;
                }
            }
            
            // Preserve line breaks and paragraphs in the original text
            // Replace \n with <br> and preserve paragraph structure
            let formattedText = originalText
                .replace(/\n\n/g, '</p><p>') // Double line breaks indicate paragraphs
                .replace(/\n/g, '<br>'); // Single line breaks
            
            // Wrap the text in paragraph tags if it doesn't start with one
            if (!formattedText.startsWith('<p>')) {
                formattedText = '<p>' + formattedText;
            }
            if (!formattedText.endsWith('</p>')) {
                formattedText = formattedText + '</p>';
            }
            
            // Create highlighted text by replacing both variants
            let highlightedText = formattedText;
            
            // Highlight British spelling if it exists
            if (britishWord) {
                const britishRegex = new RegExp('\\b(' + escapeRegExp(britishWord) + ')\\b', 'gi');
                highlightedText = highlightedText.replace(britishRegex, 
                    '<span class="british-highlight">$1</span>');
            }
            
            // Highlight American spelling if it exists
            if (americanWord) {
                const americanRegex = new RegExp('\\b(' + escapeRegExp(americanWord) + ')\\b', 'gi');
                highlightedText = highlightedText.replace(americanRegex, 
                    '<span class="american-highlight">$1</span>');
            }
            
            // Set the highlighted text in the modal
            document.getElementById('highlighted-text').innerHTML = highlightedText;
            
            // Set the modal title to indicate both spellings are highlighted
            document.getElementById('highlight-modal-title').textContent = 
                variant === 'british' 
                    ? `Highlighting "${britishWord}" (British) and "${americanWord}" (American)` 
                    : `Highlighting "${britishWord}" (British) and "${americanWord}" (American)`;
            
            // Show the modal
            document.getElementById('highlight-modal').style.display = 'block';
            
            // Mark clicked word as selected in the table
            document.querySelectorAll('.selected-word').forEach(el => {
                el.classList.remove('selected-word');
            });
            
            const selector = variant === 'british' ? '.british-word' : '.american-word';
            document.querySelectorAll(selector).forEach(el => {
                if (el.textContent.toLowerCase() === word.toLowerCase()) {
                    el.classList.add('selected-word');
                }
            });
        }
        
        // Helper function to escape special characters in regex
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
    </script>
    {% endif %}
</body>
</html>